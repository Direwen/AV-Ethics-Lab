@startuml ERD

!define TABLE(x) entity x << (T,#FFAAAA) >>

skinparam linetype ortho
skinparam roundcorner 10
skinparam shadowing false

TABLE(sessions) {
  * id : uuid <<PK>>
  --
  fingerprint : varchar(255)
  is_duplicate : boolean
  self_reported_new : boolean
  age_range : smallint
  gender : smallint
  country : varchar(10)
  occupation : varchar(50)
  driving_experience : smallint
  status : smallint
  expires_at : timestamp
  experiment_plan : jsonb
  feedback : jsonb
  created_at : timestamp
  updated_at : timestamp
  deleted_at : timestamp
}

TABLE(context_templates) {
  * id : uuid <<PK>>
  --
  name : varchar
  width : int
  height : int
  grid_data : jsonb
  lane_config : jsonb
  meta : jsonb
  created_at : timestamp
  updated_at : timestamp
  deleted_at : timestamp
}

TABLE(scenarios) {
  * id : uuid <<PK>>
  --
  * context_template_id : uuid <<FK>>
  * session_id : uuid <<FK>>
  entities : jsonb
  factors : jsonb
  dilemma_options : jsonb
  narrative : text
  trident_spawn : jsonb
  started_at : timestamp
  created_at : timestamp
  updated_at : timestamp
  deleted_at : timestamp
}

TABLE(responses) {
  * id : uuid <<PK>>
  --
  * scenario_id : uuid <<FK>> <<UNIQUE>>
  ranking_order : jsonb
  is_timeout : boolean
  has_interacted : boolean
  response_time_ms : bigint
  created_at : timestamp
  updated_at : timestamp
  deleted_at : timestamp
}

sessions ||--o{ scenarios : "has many"
context_templates ||--o{ scenarios : "has many"
scenarios ||--o| responses : "has one"

note right of sessions
  Session tracks participant
  demographics and experiment
  plan. Status: Active, Completed,
  Expired, Abandoned
end note

note right of scenarios
  Each scenario contains:
  - Entity placements (JSON)
  - Environmental factors
  - Dilemma options
  - Trident spawn point
end note

note right of responses
  Response captures:
  - Ranked action preferences
  - Response time
  - Timeout/interaction flags
end note

@enduml
